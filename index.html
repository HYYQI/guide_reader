<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>å¯¼æ¸¸è¯é˜…è¯»å™¨</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f6fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1a3243;
        }
        .navbar {
            background: white;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-bottom: 1px solid #cfddee;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.95rem;
        }
        .logo {
            font-weight: 600;
            color: #1e4b6e;
            margin-right: 0.25rem;
        }
        .file-select {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.4rem;
            flex: 1;
        }
        .file-select select {
            flex: 1;
            min-width: 160px;
            padding: 0.4rem 1.8rem 0.4rem 0.8rem;
            border-radius: 24px;
            border: 1px solid #b4c9db;
            background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>') no-repeat right 8px center;
            background-size: 14px;
            appearance: none;
            font-size: 0.95rem;
        }
        .refresh-btn {
            background: #ecf2f8;
            border: 1px solid #adc2d4;
            border-radius: 30px;
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .refresh-btn:active { background: #d7e2ed; }
        .reader {
            flex: 1;
            padding: 1rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .paper {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            padding: 1.5rem 1.2rem;
            min-height: 60vh;
        }
        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding-bottom: 0.8rem;
            margin-bottom: 1.2rem;
            border-bottom: 1px dashed #c4d3e3;
        }
        .file-name {
            font-size: 1.3rem;
            font-weight: 500;
            color: #13456b;
            word-break: break-word;
        }
        .count {
            background: #e2ebf3;
            padding: 0.2rem 0.9rem;
            border-radius: 30px;
            font-size: 0.8rem;
            color: #1e4b70;
        }
        .sentence-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .sentence-item {
            padding: 0.8rem 1rem 0.8rem 1.2rem;
            background: #f9fcff;
            border-left: 4px solid #6f9bc0;
            border-radius: 8px 16px 16px 8px;
            font-size: 1.1rem;
            line-height: 1.6;
            word-break: break-word;
        }
        .placeholder, .error, .loading {
            text-align: center;
            padding: 3rem 1rem;
            border-radius: 40px;
        }
        .placeholder { color: #627d96; background: #f0f7ff; border: 2px dashed #c1d6e8; }
        .error { color: #b13e3e; background: #ffecec; }
        .loading { color: #2f6585; background: #e8f0fa; }
    </style>
</head>
<body>
    <div class="navbar">
        <span class="logo">ğŸ“– å¯¼æ¸¸è¯</span>
        <div class="file-select">
            <select id="fileSelector" aria-label="é€‰æ‹©å¯¼æ¸¸è¯æ–‡ä»¶">
                <option value="">â€” åŠ è½½ç›®å½•ä¸­ â€”</option>
            </select>
            <button class="refresh-btn" id="refreshBtn">â†» åˆ·æ–°</button>
        </div>
    </div>
    <div class="reader">
        <div class="paper" id="readerPaper">
            <div class="placeholder" id="placeholderMsg">
                <div>ğŸ“ é€‰æ‹©ä¸Šæ–¹æ–‡ä»¶å¼€å§‹é˜…è¯»</div>
                <div style="font-size:0.9rem; margin-top:0.5rem;">ä» text/ ç›®å½•è·å–</div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const fileSelector = document.getElementById('fileSelector');
            const refreshBtn = document.getElementById('refreshBtn');
            const readerPaper = document.getElementById('readerPaper');

            let currentFileName = '';
            let fileList = []; // { name, path }

            function showPlaceholder(msg) {
                readerPaper.innerHTML = `<div class="placeholder">${msg || 'ğŸ“ é€‰æ‹©æ–‡ä»¶'}</div>`;
            }
            function showError(msg) {
                readerPaper.innerHTML = `<div class="error">âŒ ${msg}</div>`;
            }
            function showLoading() {
                readerPaper.innerHTML = `<div class="loading">â³ åŠ è½½ä¸­...</div>`;
            }
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }

            // æŒ‰å¥å­æ‹†åˆ†
            function splitSentences(text) {
                if (!text) return [];
                const clean = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
                const sentences = clean.split(/(?<=[ã€‚ï¼ï¼Ÿ.!?])\s*/).filter(s => s.trim().length > 0);
                if (sentences.length <= 1 && clean.includes('\n')) {
                    return clean.split('\n').filter(s => s.trim().length > 0).map(s => s.trim());
                }
                return sentences.map(s => s.trim());
            }

            function renderContent(content, fileName) {
                if (!content || content.trim() === '') {
                    readerPaper.innerHTML = `
                        <div class="file-header"><span class="file-name">${escapeHtml(fileName)}</span><span class="count">ç©ºæ–‡ä»¶</span></div>
                        <div class="placeholder">ğŸ“­ æ²¡æœ‰å†…å®¹</div>
                    `;
                    return;
                }
                const sentences = splitSentences(content);
                const header = `<div class="file-header"><span class="file-name">${escapeHtml(fileName)}</span><span class="count">${sentences.length} å¥</span></div>`;
                let listHtml = '<div class="sentence-list">';
                sentences.forEach(s => { listHtml += `<div class="sentence-item">${escapeHtml(s)}</div>`; });
                listHtml += '</div>';
                readerPaper.innerHTML = header + listHtml;
            }

            function loadFileContent(filePath, fileName) {
                showLoading();
                fetch(filePath)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return res.text();
                    })
                    .then(text => renderContent(text, fileName))
                    .catch(err => {
                        console.error(err);
                        showError(`è¯»å–å¤±è´¥: ${fileName} (${err.message})`);
                    });
            }

            // æ ¸å¿ƒï¼šç›´æ¥è·å– /text ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆè§£æHTMLç´¢å¼•é¡µé¢ï¼‰
            function fetchFileListFromTextDir() {
                fileSelector.disabled = true;
                fileSelector.innerHTML = '<option value="">â€” æ‰«æç›®å½• â€”</option>';

                // å°è¯•è·å– text/ ç›®å½•ï¼Œå¤§å¤šæ•°æœåŠ¡å™¨ä¼šè¿”å›ç´¢å¼•é¡µé¢æˆ–403/404
                // æˆ‘ä»¬é€šè¿‡ fetch è·å– text/ ç›®å½•çš„ HTMLï¼Œç„¶åè§£æå…¶ä¸­çš„ .txt é“¾æ¥
                const textDirUrl = './text/';  // åŒçº§ç›®å½•ä¸‹çš„ text æ–‡ä»¶å¤¹

                fetch(textDirUrl, { method: 'GET', cache: 'no-cache' })
                    .then(response => {
                        if (!response.ok) {
                            // å¦‚æœç›®å½•ç´¢å¼•è¢«ç¦æ­¢ï¼Œå°è¯•è·å– text/index.json æˆ–è€…é™çº§æ–¹æ¡ˆ
                            throw new Error(`æ— æ³•è®¿é—®ç›®å½•: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // è§£æ HTML ä¸­æ‰€æœ‰ .txt æ–‡ä»¶çš„é“¾æ¥ (å…¼å®¹ Apache, Nginx, ç®€å•åˆ—è¡¨)
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const links = doc.querySelectorAll('a');
                        const txtFiles = [];

                        links.forEach(link => {
                            const href = link.getAttribute('href');
                            if (href && href.toLowerCase().endsWith('.txt')) {
                                // æå–æ–‡ä»¶åï¼ˆå»é™¤å¯èƒ½çš„è·¯å¾„ï¼‰
                                let fileName = href;
                                if (fileName.includes('/')) fileName = fileName.split('/').pop();
                                if (fileName.includes('?')) fileName = fileName.split('?')[0];
                                if (fileName && fileName.toLowerCase().endsWith('.txt')) {
                                    txtFiles.push(fileName);
                                }
                            }
                        });

                        // å»é‡
                        const unique = [...new Set(txtFiles)].sort((a,b) => a.localeCompare(b));
                        
                        if (unique.length === 0) {
                            // æ²¡æœ‰è§£æåˆ° .txt æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨è¿”å›äº†éç´¢å¼•é¡µé¢ï¼Œå°è¯•é»˜è®¤åˆ—è¡¨æˆ–æŠ¥é”™
                            console.warn('æœªä»ç›®å½•è§£æåˆ°txtæ–‡ä»¶ï¼Œå°è¯•å¸¸ç”¨æ–‡ä»¶å');
                            // æœ€åå°è¯•å‡ ä¸ªå¸¸è§æ–‡ä»¶åï¼ˆå¯æ‰‹å·¥æ·»åŠ ï¼‰
                            const fallback = ['æ•…å®«.txt', 'é¢å’Œå›­.txt', 'é•¿åŸ.txt', 'å¤©å›.txt', 'å…µé©¬ä¿‘.txt'];
                            // è¿‡æ»¤å­˜åœ¨æ€§ï¼Ÿæ²¡æ³•éªŒè¯ï¼Œç›´æ¥å±•ç¤ºè®©ç”¨æˆ·ç‚¹
                            updateSelectorWithFiles(fallback);
                        } else {
                            updateSelectorWithFiles(unique);
                        }
                    })
                    .catch(err => {
                        console.warn('ç›®å½•è·å–å¤±è´¥:', err);
                        // é™çº§æ–¹æ¡ˆï¼šå±•ç¤ºé»˜è®¤é¢„è®¾ï¼ˆç¡®ä¿è‡³å°‘èƒ½å·¥ä½œï¼‰
                        const defaultFiles = ['æ•…å®«.txt', 'é¢å’Œå›­.txt', 'é•¿åŸ.txt', 'å…µé©¬ä¿‘.txt', 'å¤©å›.txt'];
                        updateSelectorWithFiles(defaultFiles);
                    });
            }

            function updateSelectorWithFiles(filenames) {
                if (!filenames || filenames.length === 0) {
                    fileSelector.innerHTML = '<option value="">â€” æ— txtæ–‡ä»¶ â€”</option>';
                    fileSelector.disabled = false;
                    return;
                }

                // è¿‡æ»¤ .txt å¹¶å»é‡
                const unique = [...new Set(filenames.filter(f => f && f.toLowerCase().endsWith('.txt')))];
                if (unique.length === 0) {
                    fileSelector.innerHTML = '<option value="">â€” æ— txtæ–‡ä»¶ â€”</option>';
                    fileSelector.disabled = false;
                    return;
                }

                // æ„å»º options
                let options = '<option value="">â€” é€‰æ‹©æ–‡ä»¶ â€”</option>';
                unique.forEach(name => {
                    const selected = (name === currentFileName) ? 'selected' : '';
                    options += `<option value="${escapeHtml(name)}" ${selected}>${escapeHtml(name)}</option>`;
                });
                fileSelector.innerHTML = options;
                fileSelector.disabled = false;

                // æ›´æ–° fileList
                fileList = unique.map(name => ({
                    name,
                    path: `./text/${encodeURIComponent(name)}`
                }));

                // å¦‚æœå½“å‰æ–‡ä»¶åè¿˜åœ¨åˆ—è¡¨ä¸­ï¼Œè‡ªåŠ¨åŠ è½½ï¼ˆé€šå¸¸é¦–æ¬¡æ²¡æœ‰ï¼‰
                if (currentFileName && unique.includes(currentFileName)) {
                    const file = fileList.find(f => f.name === currentFileName);
                    if (file) loadFileContent(file.path, file.name);
                } else {
                    currentFileName = '';
                    // ä¸æ¸…ç©ºå ä½ï¼Œé™¤éç”¨æˆ·é€‰æ‹©
                }
            }

            // é€‰æ‹©äº‹ä»¶
            fileSelector.addEventListener('change', function(e) {
                const name = e.target.value;
                if (!name) {
                    currentFileName = '';
                    showPlaceholder('è¯·é€‰æ‹©æ–‡ä»¶');
                    return;
                }
                const file = fileList.find(f => f.name === name);
                if (file) {
                    currentFileName = file.name;
                    loadFileContent(file.path, file.name);
                } else {
                    // å®¹é”™ï¼šé‡æ–°æ‰«æ
                    fetchFileListFromTextDir();
                }
            });

            refreshBtn.addEventListener('click', function() {
                fetchFileListFromTextDir();
            });

            // åˆå§‹åŒ–
            fetchFileListFromTextDir();
        })();
    </script>
</body>
</html>
