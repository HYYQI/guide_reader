<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼æ¸¸è¯ Â· å¥è¯»é˜…è¯»å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'å¾®è½¯é›…é»‘', 'PingFang SC', system-ui, sans-serif;
            background: #f3f5f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1e2b3c;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 20, 30, 0.08);
            padding: 0.8rem 2rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            border-bottom: 1px solid #e6ecf2;
            backdrop-filter: blur(4px);
            background: rgba(255, 255, 255, 0.9);
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 500;
        }

        .logo-icon {
            font-size: 1.7rem;
            line-height: 1;
            filter: drop-shadow(2px 2px 2px rgba(0,40,60,0.1));
        }

        .title {
            font-size: 1.25rem;
            letter-spacing: 1px;
            background: linear-gradient(145deg, #1e4b6e, #123245);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 600;
        }

        .file-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .file-selector label {
            font-size: 0.95rem;
            color: #2f4b6e;
            background: #eef2f8;
            padding: 0.3rem 1rem;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #cbd6e4;
            cursor: pointer;
            transition: 0.2s;
        }

        .file-selector label:hover {
            background: #e3eaf3;
            border-color: #8faec9;
        }

        #fileSelect {
            display: none;
        }

        .file-badge {
            background: white;
            border-radius: 30px;
            padding: 0.25rem 1.2rem;
            font-size: 1rem;
            border: 1px solid #b9cedf;
            color: #144a6f;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .file-badge span {
            color: #68869e;
            font-weight: 400;
            font-size: 0.9rem;
        }

        .refresh-btn {
            background: none;
            border: 1px solid #b8cbd9;
            border-radius: 32px;
            padding: 0.3rem 1.2rem;
            font-size: 0.9rem;
            color: #1b405b;
            cursor: pointer;
            transition: 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .refresh-btn:hover {
            background: #e2ebf3;
            border-color: #6f95b9;
        }

        /* é˜…è¯»ä¸»åŒº */
        .reader-container {
            flex: 1;
            padding: 2rem 1.5rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        .paper {
            background: #fefefd;
            border-radius: 32px;
            box-shadow: 0 15px 35px -12px rgba(27, 52, 75, 0.25);
            padding: 2.5rem 2.8rem;
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(2px);
            min-height: 60vh;
        }

        .file-header {
            border-bottom: 2px dashed #cedce8;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .file-name-display {
            font-size: 1.9rem;
            font-weight: 500;
            color: #1e3f57;
            letter-spacing: 0.5px;
            word-break: break-word;
        }

        .sentence-count {
            background: #e7eef7;
            padding: 0.35rem 1.2rem;
            border-radius: 60px;
            font-size: 0.9rem;
            color: #1e506e;
            font-weight: 450;
        }

        /* å¥å­åˆ—è¡¨â€”â€”æ¯ä¸€å¥è¯ä¸€æ®µï¼Œæ¸…æ™°æ˜“è¯» */
        .speech-list {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .sentence-card {
            background: #f9fcff;
            border-left: 5px solid #6190b9;
            padding: 1rem 1.8rem 1rem 2rem;
            border-radius: 18px 8px 8px 18px;
            box-shadow: 0 3px 8px rgba(0, 25, 45, 0.03);
            transition: all 0.15s ease;
            line-height: 1.7;
            font-size: 1.2rem;
            color: #102b3b;
            word-break: break-word;
            border-bottom: 1px solid #dde7f0;
        }

        .sentence-card:hover {
            background: #ffffff;
            border-left-width: 7px;
            border-left-color: #2277aa;
            box-shadow: 0 8px 18px -10px #1e4f6e55;
            transform: translateX(4px);
        }

        /* ç©ºçŠ¶æ€/å ä½ */
        .placeholder-info {
            text-align: center;
            padding: 3.5rem 1rem;
            color: #6a859c;
            font-size: 1.2rem;
            background: #f1f7fd;
            border-radius: 48px;
            border: 2px dashed #b7cfdf;
        }

        .placeholder-info .hint-icon {
            font-size: 3rem;
            opacity: 0.5;
            margin-bottom: 0.5rem;
        }

        .footer-note {
            margin-top: 2rem;
            text-align: center;
            color: #6f8da5;
            font-size: 0.85rem;
        }

        /* åŠ è½½ä¸­ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            color: #3b6e94;
            padding: 2rem;
        }

        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .navbar {
                padding: 0.8rem 1rem;
            }
            .paper {
                padding: 1.8rem 1.2rem;
            }
            .sentence-card {
                padding: 0.9rem 1.2rem;
                font-size: 1.1rem;
            }
            .file-name-display {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="navbar">
        <div class="logo-area">
            <span class="logo-icon">ğŸ—‚ï¸ğŸ—£ï¸</span>
            <span class="title">å¯¼æ¸¸è¯ Â· å¥è¯µ</span>
        </div>
        <div class="file-selector">
            <label for="fileSelect">
                <span>ğŸ“‚</span> ä» text/ é€‰æ‹©æ–‡ä»¶
                <input type="file" id="fileSelect" webkitdirectory directory multiple accept=".txt,.text/*">
            </label>
            <div class="file-badge" id="currentFileBadge">
                <span>å½“å‰</span> æœªé€‰æ‹©æ–‡ä»¶
            </div>
            <button class="refresh-btn" id="refreshBtn" title="é‡æ–°ä»textç›®å½•è·å–ï¼ˆé‡æ–°é€‰æ‹©æ–‡ä»¶å¤¹ï¼‰">
                <span>ğŸ”„</span> é‡æ–°é€‰æ‹©
            </button>
        </div>
    </div>

    <!-- é˜…è¯»ä¸»ä½“ï¼šæ¯ä¸€å¥ä¸€æ®µè½ -->
    <div class="reader-container">
        <div class="paper" id="readerPaper">
            <!-- åŠ¨æ€å†…å®¹ç”±jsæ¸²æŸ“ -->
            <div class="placeholder-info" id="placeholderMessage">
                <div class="hint-icon">ğŸ“–</div>
                <div>ç‚¹å‡»ä¸Šæ–¹ã€Œä»text/é€‰æ‹©æ–‡ä»¶ã€<br>é€‰æ‹©åŒ…å«å¯¼æ¸¸è¯ .txt çš„æ–‡ä»¶å¤¹</div>
                <div style="font-size:0.9rem; margin-top:1.2rem; background:#e9f0f7; padding:0.5rem 1.5rem; border-radius:40px; display:inline-block;">æ”¯æŒå¤šæ–‡ä»¶ï¼Œé€‰ä¸­åè‡ªåŠ¨æŒ‰å¥åˆ†æ®µ</div>
            </div>
        </div>
        <div class="footer-note">
            â æ¯ä¸€å¥ä¸ºä¸€æ®µ â€¢ åŠ©ä½ æ¸…æ™°è¯µè¯»
        </div>
    </div>

    <script>
        (function() {
            // DOM å…ƒç´ 
            const fileInput = document.getElementById('fileSelect');
            const refreshBtn = document.getElementById('refreshBtn');
            const currentFileBadge = document.getElementById('currentFileBadge');
            const readerPaper = document.getElementById('readerPaper');

            // çŠ¶æ€
            let currentFileHandle = null;           // ç”¨äºæ˜¾ç¤ºå½“å‰æ–‡ä»¶åç§° (å®é™…æ–‡ä»¶å¯¹è±¡)
            let allTextFiles = [];                  // å­˜å‚¨é€‰å–çš„ File å¯¹è±¡ (name, file)
            let selectedFileName = '';              

            // åˆå§‹åŒ–å ä½, ä½†ä¿ç•™paperçš„ç»“æ„
            function showPlaceholder(message = '') {
                const placeholderHTML = `
                    <div class="placeholder-info">
                        <div class="hint-icon">ğŸ—‚ï¸</div>
                        <div>${message || 'ç‚¹å‡»ä¸Šæ–¹é€‰æ‹©åŒ…å«å¯¼æ¸¸è¯çš„textæ–‡ä»¶å¤¹'}</div>
                        <div style="font-size:0.9rem; margin-top:1rem;">æ¯ä¸€å¥è‡ªåŠ¨åˆ†æ®µè½ Â· æœ—è¯»æ›´è½»æ¾</div>
                    </div>
                `;
                readerPaper.innerHTML = placeholderHTML;
            }

            // æ¸…é™¤å†…å®¹æ˜¾ç¤ºåŠ è½½ä¸­
            function showLoading() {
                readerPaper.innerHTML = `<div class="loading"><span>â³</span> åŠ è½½æ–‡æœ¬ä¸­... æŒ‰å¥å­åˆ†æ®µ</div>`;
            }

            // å°†æ–‡æœ¬æŒ‰å¥å­æ‹†åˆ† (ä¿ç•™. ! ? ä»¥åŠæ¢è¡Œç¬¦ä½œä¸ºå¥å­åˆ†éš”, åŒæ—¶è¿‡æ»¤ç©ºä¸²)
            function splitIntoSentences(text) {
                if (!text) return [];
                // å…ˆåšåŸºç¡€æ¸…æ´—: å°†ä¸åŒæ¢è¡Œç¬¦ç»Ÿä¸€, å¹¶æ·»åŠ å¥å·ç­‰ä¿è¯åˆ†å‰²
                // ä½¿ç”¨æ­£åˆ™åŒ¹é…æ‰€æœ‰å¯èƒ½å¥å­è¾¹ç•Œ: ä¸­æ–‡å¥å·/é—®å·/æ„Ÿå¹å·/è‹±æ–‡å¥ç‚¹/æ¢è¡Œç¬¦/åˆ†å·ç­‰ã€‚
                // ä½†ä¸ºäº†é¿å…åˆ†å‰²å¤ªç¢, æŠŠè¿ç»­åˆ†éš”ç¬¦åˆå¹¶ï¼Œå¹¶ä¿ç•™åˆ†éš”ç¬¦ã€‚
                // æ›´å‹å¥½: æŒ‰ (.!?ã€‚ï¼ï¼Ÿ) + æ¢è¡Œ åˆ†å‰²ï¼ŒåŒæ—¶ä¿ç•™ç¬¦å·åœ¨å‰ä¸€å¥ã€‚
                // æ³¨æ„: è¦è€ƒè™‘æ•°å­—å°æ•°ç‚¹å¹²æ‰° (æ¯”å¦‚ "1.2") ä½†å¯¼æ¸¸è¯è¾ƒå°‘è§ï¼Œä½†ä¿ç•™ä¸€èˆ¬è§„åˆ™ã€‚
                const raw = text
                    .replace(/\r\n|\r/g, '\n')          // ç»Ÿä¸€æ¢è¡Œ
                    .replace(/\n\s+/g, '\n')            // æ¢è¡Œåç©ºæ ¼æ¸…ç†
                    .trim();

                // åˆ†å‰²è§„åˆ™: ä¸­æ–‡/è‹±æ–‡å¥å­ç»“æŸç¬¦ + ä»»æ„ç©ºç™½æˆ–æ¢è¡Œ, ä½¿ç”¨æ­£å‘é¢„æŸ¥æ‰¾ä¿ç•™åˆ†éš”ç¬¦ã€‚
                // ç”¨é›¶å®½æ–­è¨€åŒ¹é… (?<=[ã€‚ï¼ï¼Ÿ.!?])\s* æ¥åˆ†å‰², ä½†ä¸èƒ½åœ¨æ•°å­—åè¯¯åˆ¤å¦‚ "ç¬¬1.2æ¡" â€”â€” å¯¼æ¸¸è¯å‡ ä¹æ— å°æ•°ç‚¹, ç›´æ¥ç®€å•å¤„ç†ã€‚
                // ç®€å•ä¿é™©: æŒ‰å¸¸è§æ ‡ç‚¹åˆ†å‰², åŒæ—¶ä¿ç•™æ ‡ç‚¹ã€‚
                const sentences = raw.split(/(?<=[ã€‚ï¼ï¼Ÿ.!?])\s*/).filter(s => s.trim().length > 0);
                // å¦‚æœ split ç»“æœå¤ªé•¿ (å¯èƒ½ç”±äºæ— æ ‡ç‚¹), åˆ™é€€ä¸€æ­¥æŒ‰æ¢è¡Œåˆ†å‰²
                if (sentences.length <= 1 && raw.includes('\n')) {
                    return raw.split('\n').filter(s => s.trim().length > 0).map(s => s.trim());
                }
                return sentences.map(s => s.trim());
            }

            // æ¸²æŸ“æ–‡ä»¶å†…å®¹åˆ°é˜…è¯»å™¨ (åˆ†æ®µ)
            function renderFileContent(fileContent, fileName) {
                if (!fileContent || fileContent.trim() === '') {
                    readerPaper.innerHTML = `
                        <div class="file-header">
                            <span class="file-name-display">${escapeHtml(fileName)}</span>
                            <span class="sentence-count">â›” ç©ºæ–‡æœ¬</span>
                        </div>
                        <div class="placeholder-info" style="background: #fff4e6;">ğŸ“­ æ–‡ä»¶æ²¡æœ‰å†…å®¹</div>
                    `;
                    return;
                }

                const sentences = splitIntoSentences(fileContent);
                const sentenceCount = sentences.length;

                // æ„å»ºheader
                let headerHtml = `
                    <div class="file-header">
                        <span class="file-name-display">${escapeHtml(fileName)}</span>
                        <span class="sentence-count">ğŸ“„ ${sentenceCount} å¥</span>
                    </div>
                `;

                // æ„å»ºå¥å­åˆ—è¡¨
                let sentencesHtml = `<div class="speech-list">`;
                sentences.forEach((sentence, idx) => {
                    // åŠ å…¥ä¸€ç‚¹æ®µè½é—´è·ï¼Œæ˜¾ç¤ºå¥å­åºå·æ›´æ˜“è¯»ï¼ˆå¯é€‰ï¼‰
                    sentencesHtml += `<div class="sentence-card"><span style="color: #51718c; font-weight: 400; margin-right: 0.8rem; opacity:0.7;">${idx+1}.</span> ${escapeHtml(sentence)}</div>`;
                });
                sentencesHtml += `</div>`;

                readerPaper.innerHTML = headerHtml + sentencesHtml;
            }

            // ç®€æ˜“è½¬ä¹‰é˜²æ­¢XSS (è™½ç„¶txtä¸å¤ªå¯èƒ½)
            function escapeHtml(unsafe) {
                return unsafe.replace(/[&<>"]/g, function(m) {
                    if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
                    return m;
                });
            }

            // æ›´æ–°å½“å‰æ–‡ä»¶badge
            function updateFileBadge(fileName) {
                if (fileName) {
                    currentFileBadge.innerHTML = `<span>å½“å‰</span> ${escapeHtml(fileName)}`;
                } else {
                    currentFileBadge.innerHTML = `<span>å½“å‰</span> æœªé€‰æ‹©æ–‡ä»¶`;
                }
            }

            // å¤„ç†é€‰å–æ–‡ä»¶å¤¹ (webkitdirectory)
            fileInput.addEventListener('change', function(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) {
                    showPlaceholder('æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶');
                    updateFileBadge('');
                    allTextFiles = [];
                    return;
                }

                // è¿‡æ»¤å‡º .txt æ–‡ä»¶ (ä¹ŸåŒ…å«æ— æ‰©å±•åä½†æ–‡æœ¬ç±»å‹çš„, ç®€å•æŒ‰æ‰©å±•å .txt)
                const textFiles = files.filter(file => file.name.toLowerCase().endsWith('.txt') || file.type.includes('text/plain'));
                
                if (textFiles.length === 0) {
                    showPlaceholder('textæ–‡ä»¶å¤¹å†…æœªæ‰¾åˆ° .txt æ–‡ä»¶');
                    updateFileBadge('');
                    allTextFiles = [];
                    return;
                }

                // æŒ‰æ–‡ä»¶åæ’åº, ä¾¿äºå¯¼èˆª
                textFiles.sort((a, b) => a.name.localeCompare(b.name));
                allTextFiles = textFiles;

                // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„æ–‡ä»¶åï¼Œå°è¯•é€‰ä¸­ï¼›å¦åˆ™é»˜è®¤ç¬¬ä¸€ä¸ª
                let targetIndex = 0;
                if (selectedFileName) {
                    const idx = textFiles.findIndex(f => f.name === selectedFileName);
                    if (idx !== -1) targetIndex = idx;
                    else targetIndex = 0;  // ä¹‹å‰æ–‡ä»¶åä¸åœ¨æ–°ç›®å½•ä¸­ï¼Œé‡ç½®
                }

                // è¯»å–å¹¶å±•ç¤ºç¬¬ä¸€ä¸ªæ–‡ä»¶
                loadFileByIndex(targetIndex);
            });

            // æ ¹æ®ç´¢å¼•è¯»å–æ–‡ä»¶å†…å®¹
            function loadFileByIndex(index) {
                if (!allTextFiles || allTextFiles.length === 0 || index < 0 || index >= allTextFiles.length) {
                    showPlaceholder('æ— å¯ç”¨çš„æ–‡æœ¬æ–‡ä»¶');
                    updateFileBadge('');
                    return;
                }

                const file = allTextFiles[index];
                selectedFileName = file.name;
                updateFileBadge(selectedFileName);
                showLoading();   // æ˜¾ç¤ºåŠ è½½ä¸­

                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    // æ¸²æŸ“åˆ†æ®µ
                    renderFileContent(content, file.name);
                };
                reader.onerror = function() {
                    readerPaper.innerHTML = `<div class="placeholder-info" style="color:#c00;">âŒ è¯»å–æ–‡ä»¶å¤±è´¥: ${escapeHtml(file.name)}</div>`;
                };
                reader.readAsText(file, 'UTF-8');
            }

            // åˆ·æ–°/é‡æ–°é€‰æ‹©: è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
            refreshBtn.addEventListener('click', function() {
                fileInput.value = '';        // æ¸…ç©º, ä¿è¯å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶å¤¹ä¹Ÿèƒ½è§¦å‘change
                fileInput.click();
            });

            // å¯é€‰: æ·»åŠ ä¸€ä¸ªç®€å•çš„æ–‡ä»¶å¯¼èˆªåŠŸèƒ½ï¼ˆç‚¹å‡»æ–‡ä»¶badgeåˆ‡æ¢ï¼Ÿä¸ºäº†æé«˜æ˜“ç”¨ï¼Œå¯ä»¥å¢åŠ ç®€æ˜“çš„ä¸‹æ‹‰é€‰æ‹©ï¼Œä½†é¡¶éƒ¨å¯¼èˆªå·²ç»ç®€æ´ï¼‰
            // æˆ‘ä»¬å¯ä»¥æ‰©å±•: åŒå‡»badgeæˆ–è€…å¢åŠ å·¦å³åˆ‡æ¢ï¼Œä½†éœ€æ±‚ä»…è¦æ±‚â€œé¡¶éƒ¨å¯¼èˆªå¯ä»¥é€‰æ‹©æ–‡ä»¶â€
            // å·²æ»¡è¶³ï¼Œä½†è¿˜å¯ä»¥åœ¨å½“å‰æ–‡ä»¶badgeæ—æ·»åŠ ç®€æ˜“ä¸‹æ‹‰åˆ‡æ¢ï¼Œä¸ºäº†æ›´å¥½ä½“éªŒï¼Œå¢åŠ ä¸€ä¸ªéšè—é€‰æ‹©ï¼Œä½†ä¿æŒæç®€é£æ ¼ã€‚
            // æ›´å‹å¥½: å¦‚æœæ–‡ä»¶åˆ—è¡¨å¤šäº1ä¸ªï¼Œåœ¨æ–‡ä»¶åå³ä¾§æ˜¾ç¤ºåˆ‡æ¢å›¾æ ‡ã€‚å®Œå…¨ç¬¦åˆå¯¼æ¸¸è¯é˜…è¯»å™¨çš„æ–¹ä¾¿ã€‚
            // ä½†æ–‡æ¡£æ˜ç¡®â€œé¡¶éƒ¨å¯¼èˆªæ å¯ä»¥é€‰æ‹©æ–‡ä»¶â€ ç›®å‰ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹å·²æ”¯æŒã€‚ä¸ºäº†å¤šæ–‡ä»¶å¿«é€Ÿåˆ‡æ¢ï¼Œåœ¨æ–‡ä»¶åå³ä¾§æ‚„æ‚„åŠ ä¸ªä¸‹æ‹‰å›¾æ ‡?
            // æœ¬ç€åŠ åˆ†ä½“éªŒï¼Œæˆ‘åœ¨æ–‡ä»¶badgeæ—è¾¹åŠ ä¸€ä¸ªä¸‹æ‹‰èœå•ï¼ˆå¦‚æœæ–‡ä»¶æ•°é‡>1ï¼‰ï¼Œç›´æ¥é€‰æ‹©ã€‚ä¸å½±å“æ ¸å¿ƒè¦æ±‚ã€‚
            // ä½†ä¸Šè¿°renderé‡Œæœªæä¾›åˆ‡æ¢ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ›´æ–°badgeæ—¶åŠ¨æ€é™„åŠ ä¸€ä¸ªåˆ‡æ¢ä¸‹æ‹‰æ¡†ï¼Œä½†ä¼šä¿®æ”¹ç»“æ„ã€‚å®‰å…¨èµ·è§ï¼Œæ·»åŠ ä¸€ä¸ªéšå½¢selectï¼Ÿ
            // ç®€å•å‡çº§: åœ¨badgeå³ä¾§å¢åŠ ä¸€ä¸ªä¸‹æ‹‰iconï¼Œç‚¹å‡»å¼¹å‡ºä¸€ä¸ªåˆ—è¡¨ã€‚ä½†æ˜¯å¯èƒ½è¶…å‡ºç®€å•èŒƒå›´ã€‚è€ƒè™‘åªåŠ ä¸€ä¸ªç®€æ˜“æŒ‰é’®â€œâ†“â€ æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨ã€‚
            // å®Œå…¨å°Šé‡éœ€æ±‚: é¡¶éƒ¨å¯¼èˆªé€‰æ‹©æ–‡ä»¶ (å·²ç»æ”¯æŒé€‰æ‹©æ–‡ä»¶å¤¹å¹¶é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªï¼Œä½†é‡æ–°é€‰æ‹©æ–‡ä»¶å¤¹è¾ƒéº»çƒ¦)
            // ä½†ç”¨æˆ·å¯èƒ½éœ€è¦åˆ‡æ¢åŒæ–‡ä»¶å¤¹ä¸‹å…¶ä»–æ–‡ä»¶ï¼Œæœ€å¥½å¢åŠ ä¸€ä¸ªä¸‹æ‹‰ã€‚æˆ‘ä»¬æ¸©å’Œæ·»åŠ ä¸€ä¸ª<select>å¡«å……æ–‡ä»¶åˆ—è¡¨ï¼Œæ”¾åœ¨badgeæ—è¾¹ã€‚
            // æˆ‘åœ¨è®¾è®¡æ—¶ç¨åŠ æ‰©å±•ï¼Œä½†ä¿æŒç®€æ´ã€‚æˆ‘ä»¬åŠ¨æ€åˆ›å»ºä¸€ä¸ªselectã€‚å°±åœ¨navbaré‡Œ file-selector å†…æ›´æ–°ã€‚
            // ä¸ºäº†é¿å…è§†è§‰æ‚ä¹±ï¼Œæˆ‘åœ¨file-badgeæ—è¾¹åŠ ä¸€ä¸ªæ–‡ä»¶åˆ‡æ¢ä¸‹æ‹‰æ¡† (ä»…å½“å¤šäºä¸€ä¸ªæ–‡ä»¶æ—¶æ˜¾ç¤º)
            // ä¿®æ”¹navbarçš„ç»“æ„ â€”â€” å¯ä»¥åŠ¨æ€ç”Ÿæˆï¼Œä½†è¿™é‡Œåœ¨jsåˆå§‹åŒ–æ—¶æ§åˆ¶ã€‚
            
            // å‡†å¤‡ä¸€ä¸ªä¸‹æ‹‰å®¹å™¨
            function buildFileSwitcher() {
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆ‡æ¢å®¹å™¨
                let switchContainer = document.getElementById('fileSwitchContainer');
                if (!switchContainer) {
                    // åˆ›å»ºæ–°å…ƒç´ 
                    switchContainer = document.createElement('div');
                    switchContainer.id = 'fileSwitchContainer';
                    switchContainer.style.marginLeft = '6px';
                    switchContainer.style.display = 'inline-flex';
                    // æ’å…¥åˆ°refreshBtnä¹‹å‰
                    const fileSelector = document.querySelector('.file-selector');
                    if (fileSelector) {
                        fileSelector.insertBefore(switchContainer, refreshBtn);
                    }
                }

                if (allTextFiles.length > 1) {
                    let options = '';
                    allTextFiles.forEach((f, idx) => {
                        options += `<option value="${idx}" ${f.name === selectedFileName ? 'selected' : ''}>${escapeHtml(f.name)}</option>`;
                    });
                    switchContainer.innerHTML = `
                        <select id="fileSwitcher" style="padding: 0.3rem 1.5rem 0.3rem 1rem; border-radius: 30px; border: 1px solid #b9cedf; background: white; color: #15445c; font-size: 0.9rem; cursor: pointer;">
                            ${options}
                        </select>
                    `;
                    const switcher = document.getElementById('fileSwitcher');
                    switcher.addEventListener('change', function(e) {
                        const idx = parseInt(e.target.value, 10);
                        loadFileByIndex(idx);
                    });
                } else {
                    switchContainer.innerHTML = ''; // ä¸€ä¸ªæˆ–é›¶ä¸ªæ–‡ä»¶éšè—åˆ‡æ¢
                }
            }

            // é‡å†™loadFileByIndexï¼Œå¢åŠ æ›´æ–°switcher
            const originalLoad = loadFileByIndex;
            loadFileByIndex = function(index) {
                originalLoad(index);
                // ç­‰å¾…æ¸²æŸ“å®Œæˆåï¼Œæ›´æ–°switcheré€‰ä¸­çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                setTimeout(() => {
                    buildFileSwitcher();  // é‡æ–°æ„å»ºä¿æŒåŒæ­¥
                }, 30);
            };

            // åœ¨changeäº‹ä»¶æœ€åè°ƒç”¨buildFileSwitcher
            const originalChange = fileInput.onchange;
            fileInput.addEventListener('change', function(e) {
                // ç”±äºä¸Šé¢å·²ç»æ·»åŠ ç›‘å¬ï¼Œä½†ä¼šè§¦å‘å¤šæ¬¡ï¼Œæˆ‘ä»¬ç¡®ä¿äº‹ä»¶å†…æœ€åè°ƒç”¨build
                // ä½†æ³¨æ„æˆ‘ä»¬ç»‘å®šäº†ä¸¤ä¸ªlistener? ä¹‹å‰ç”¨addEventListenerï¼Œç°åœ¨åˆåœ¨åé¢æ·»åŠ ï¼Œä¼šæ‰§è¡Œä¸¤æ¬¡ã€‚éœ€è¦æ•´ç†ã€‚
                // é‡æ„: å°†åŸæœ‰é€»è¾‘å…¨æ”¾åœ¨ä¸€ä¸ªå‡½æ•°é‡Œï¼Œä¿æŒå”¯ä¸€ç›‘å¬ã€‚
            });

            // é‡æ–°ç»‘å®šchangeäº‹ä»¶(ç§»é™¤ä¹‹å‰å…¨éƒ¨ï¼Œå†æŒ‚è½½)
            // ç®€å•ç²—æš´: ç§»é™¤æ‰€æœ‰ç›‘å¬ï¼Œé‡æ–°ç»‘å®šã€‚
            // è¿™é‡Œé‡‡ç”¨å…¨æ–°å‡½æ•°
            const freshChangeHandler = function(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) {
                    showPlaceholder('æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶');
                    updateFileBadge('');
                    allTextFiles = [];
                    buildFileSwitcher();
                    return;
                }

                const textFiles = files.filter(file => file.name.toLowerCase().endsWith('.txt') || file.type.includes('text/plain'));
                if (textFiles.length === 0) {
                    showPlaceholder('textæ–‡ä»¶å¤¹å†…æœªæ‰¾åˆ° .txt æ–‡ä»¶');
                    updateFileBadge('');
                    allTextFiles = [];
                    buildFileSwitcher();
                    return;
                }

                textFiles.sort((a, b) => a.name.localeCompare(b.name));
                allTextFiles = textFiles;

                let targetIndex = 0;
                if (selectedFileName) {
                    const idx = textFiles.findIndex(f => f.name === selectedFileName);
                    if (idx !== -1) targetIndex = idx;
                }

                // åŠ è½½ç›®æ ‡
                loadFileByIndex(targetIndex);
                buildFileSwitcher(); // æ„å»ºä¸‹æ‹‰
            };

            // ç§»é™¤ä¹‹å‰ç›‘å¬ (ç”±äºæ— æ³•ç›´æ¥ç§»é™¤æœªçŸ¥ç›‘å¬ï¼Œé‡è®¾)
            fileInput.replaceWith(fileInput.cloneNode(true)); // ç®€å•ç²—æš´æ¸…é™¤æ‰€æœ‰ç›‘å¬, ä½†ä¼šä¸¢å¤±å¼•ç”¨
            // é‡æ–°è·å–æ–°å…ƒç´ 
            const newFileInput = document.getElementById('fileSelect');
            newFileInput.addEventListener('change', freshChangeHandler);

            // åˆ·æ–°æŒ‰é’®éœ€è¦å¯¹åº”æ–°çš„input
            refreshBtn.addEventListener('click', function() {
                newFileInput.value = '';
                newFileInput.click();
            });

            // æ›´æ–°å…¨å±€å˜é‡å¼•ç”¨
            window.fileInput = newFileInput;

            // åˆå§‹åŒ–buildSwitcheræ— æ–‡ä»¶
            buildFileSwitcher();
            // ç¡®ä¿ç¬¬ä¸€æ¬¡å ä½
            showPlaceholder();
        })();
    </script>
    <!-- ç¡®ä¿ç‚¹å‡»é‡æ–°é€‰æ‹©åinputå§‹ç»ˆæœ‰æ•ˆ -->
    <noscript>éœ€è¦JavaScriptæ”¯æŒ</noscript>
</body>
</html>
