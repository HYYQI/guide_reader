<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导游词阅读器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding-bottom: 80px;
        }
        
        /* 顶部导航栏 */
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .current-file {
            font-size: 0.9rem;
            opacity: 0.9;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 文件选择区域 */
        .file-selector {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .file-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #444;
        }
        
        .file-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #f9f9f9;
        }
        
        /* 内容显示区域 */
        .content-container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .sentence {
            margin-bottom: 20px;
            padding: 18px 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            line-height: 1.7;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        
        .sentence-number {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        /* 控制按钮 */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            flex: 1;
            margin: 0 5px;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #555;
            flex: 1;
            margin: 0 5px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a11cb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 错误状态 */
        .error {
            text-align: center;
            padding: 40px 20px;
            color: #e74c3c;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        /* 响应式调整 */
        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .current-file {
                max-width: 100%;
                font-size: 0.85rem;
            }
            
            .sentence {
                padding: 15px;
                font-size: 1.05rem;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>导游词阅读器</h1>
            </div>
            <div class="current-file" id="currentFile">未选择文件</div>
        </div>
    </header>
    
    <!-- 文件选择区域 -->
    <div class="file-selector">
        <label for="fileSelect">选择导游词文件</label>
        <select id="fileSelect" class="file-select">
            <option value="">请选择文件...</option>
        </select>
    </div>
    
    <!-- 内容显示区域 -->
    <div class="content-container" id="contentContainer">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>
    </div>
    
    <!-- 控制按钮 -->
    <div class="controls">
        <button class="btn btn-secondary" id="prevBtn" disabled>
            上一句
        </button>
        <button class="btn btn-primary" id="nextBtn" disabled>
            下一句
        </button>
    </div>

    <script>
        // 鲜艳的颜色数组
        const brightColors = [
            "#FF6B6B", "#4ECDC4", "#FFD166", "#06D6A0", "#118AB2",
            "#EF476F", "#FF9A76", "#7BC950", "#9D4EDD", "#FFAFCC",
            "#A2D2FF", "#FF8E53", "#2A9D8F", "#E9C46A", "#F4A261",
            "#E76F51", "#2A9D8F", "#E63946", "#A8DADC", "#1D3557",
            "#FF595E", "#6A0572", "#FF9E00", "#3D5A80", "#EE6C4D"
        ];
        
        // DOM元素
        const fileSelect = document.getElementById('fileSelect');
        const contentContainer = document.getElementById('contentContainer');
        const currentFileElement = document.getElementById('currentFile');
        const loadingElement = document.getElementById('loading');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        // 当前状态
        let currentSentences = [];
        let currentIndex = 0;
        let currentFileName = "";
        
        // 1. 获取服务器上的文件列表
        async function fetchFileList() {
            try {
                const response = await fetch('./text/');
                if (!response.ok) {
                    throw new Error('无法访问text目录');
                }
                
                const html = await response.text();
                // 解析HTML获取文件列表
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = doc.querySelectorAll('a');
                
                const txtFiles = [];
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.endsWith('.txt')) {
                        txtFiles.push(href);
                    }
                });
                
                return txtFiles;
            } catch (error) {
                console.error('获取文件列表失败:', error);
                // 如果无法获取目录列表，尝试直接请求已知文件
                return ['beijing.txt', 'greatwall.txt', 'terracotta.txt'];
            }
        }
        
        // 2. 初始化文件选择下拉框
        async function initFileSelect() {
            try {
                const files = await fetchFileList();
                
                // 清空现有选项（除了第一个提示选项）
                while (fileSelect.options.length > 1) {
                    fileSelect.remove(1);
                }
                
                // 添加文件选项
                files.forEach(fileName => {
                    const option = document.createElement('option');
                    option.value = fileName;
                    option.textContent = fileName.replace('.txt', '');
                    fileSelect.appendChild(option);
                });
                
                // 如果有文件，默认选择第一个
                if (files.length > 0) {
                    fileSelect.value = files[0];
                    await loadFile(files[0]);
                }
            } catch (error) {
                showError('无法加载文件列表');
                console.error('初始化文件选择失败:', error);
            }
        }
        
        // 3. 加载选中的文件
        async function loadFile(fileName) {
            if (!fileName) return;
            
            // 显示加载状态
            showLoading();
            
            try {
                // 从服务器获取文件内容
                const response = await fetch(`./text/${fileName}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const content = await response.text();
                
                // 分割文本为句子
                currentSentences = splitIntoSentences(content);
                currentFileName = fileName;
                currentIndex = 0;
                
                // 更新当前文件显示
                currentFileElement.textContent = fileName.replace('.txt', '');
                
                // 渲染第一句
                renderCurrentSentence();
                
            } catch (error) {
                console.error('加载文件失败:', error);
                showError(`无法加载文件: ${fileName}<br>${error.message}`);
            }
        }
        
        // 4. 将文本分割为句子
        function splitIntoSentences(text) {
            // 改进的句子分割逻辑
            const sentences = [];
            let currentSentence = '';
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                currentSentence += char;
                
                // 判断句子结束
                if (char === '。' || char === '！' || char === '？' || 
                    char === '.' || char === '!' || char === '?') {
                    
                    // 检查是否可能是省略号或英文句号
                    if (char === '.' && i + 1 < text.length && text[i + 1] === '.') {
                        continue; // 跳过省略号
                    }
                    
                    if (char === '。' && i + 1 < text.length && text[i + 1] === '」') {
                        continue; // 跳过引号内的句号
                    }
                    
                    const trimmed = currentSentence.trim();
                    if (trimmed.length > 0) {
                        sentences.push(trimmed);
                    }
                    currentSentence = '';
                }
            }
            
            // 添加最后一句（如果没有结束标点）
            const lastSentence = currentSentence.trim();
            if (lastSentence.length > 0) {
                sentences.push(lastSentence);
            }
            
            return sentences;
        }
        
        // 5. 渲染当前句子
        function renderCurrentSentence() {
            contentContainer.innerHTML = '';
            
            if (currentSentences.length === 0) {
                showEmptyState();
                return;
            }
            
            // 创建句子元素
            const sentenceElement = document.createElement('div');
            sentenceElement.className = 'sentence';
            
            // 根据索引选择颜色
            const colorIndex = currentIndex % brightColors.length;
            sentenceElement.style.backgroundColor = brightColors[colorIndex];
            
            // 确保文本可读
            const textColor = getContrastColor(brightColors[colorIndex]);
            sentenceElement.style.color = textColor;
            
            // 添加句子编号
            const numberElement = document.createElement('div');
            numberElement.className = 'sentence-number';
            numberElement.textContent = `${currentIndex + 1}/${currentSentences.length}`;
            sentenceElement.appendChild(numberElement);
            
            // 添加句子内容
            const textElement = document.createElement('p');
            textElement.textContent = currentSentences[currentIndex];
            sentenceElement.appendChild(textElement);
            
            contentContainer.appendChild(sentenceElement);
            
            // 更新按钮状态
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === currentSentences.length - 1;
        }
        
        // 6. 获取对比色（确保文本可读）
        function getContrastColor(hexColor) {
            // 将十六进制颜色转换为RGB
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            
            // 计算亮度
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // 根据亮度返回黑色或白色
            return brightness > 128 ? '#000000' : '#FFFFFF';
        }
        
        // 7. 显示上一句
        function showPreviousSentence() {
            if (currentIndex > 0) {
                currentIndex--;
                renderCurrentSentence();
                scrollToTop();
            }
        }
        
        // 8. 显示下一句
        function showNextSentence() {
            if (currentIndex < currentSentences.length - 1) {
                currentIndex++;
                renderCurrentSentence();
                scrollToTop();
            }
        }
        
        // 9. 滚动到顶部
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 10. 显示加载状态
        function showLoading() {
            contentContainer.innerHTML = '';
            loadingElement.style.display = 'block';
            contentContainer.appendChild(loadingElement);
            prevBtn.disabled = true;
            nextBtn.disabled = true;
        }
        
        // 11. 显示错误状态
        function showError(message) {
            contentContainer.innerHTML = '';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<p>${message}</p>`;
            contentContainer.appendChild(errorDiv);
            prevBtn.disabled = true;
            nextBtn.disabled = true;
        }
        
        // 12. 显示空状态
        function showEmptyState() {
            contentContainer.innerHTML = '';
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state';
            emptyDiv.innerHTML = `<p>文件内容为空</p>`;
            contentContainer.appendChild(emptyDiv);
            prevBtn.disabled = true;
            nextBtn.disabled = true;
        }
        
        // 13. 添加触控滑动支持
        let touchStartX = 0;
        let touchEndX = 0;
        
        contentContainer.addEventListener('touchstart', function(event) {
            touchStartX = event.changedTouches[0].screenX;
        }, false);
        
        contentContainer.addEventListener('touchend', function(event) {
            touchEndX = event.changedTouches[0].screenX;
            handleSwipe();
        }, false);
        
        function handleSwipe() {
            const swipeThreshold = 50;
            
            if (touchEndX < touchStartX - swipeThreshold) {
                showNextSentence();
            } else if (touchEndX > touchStartX + swipeThreshold) {
                showPreviousSentence();
            }
        }
        
        // 14. 事件监听
        fileSelect.addEventListener('change', function() {
            loadFile(this.value);
        });
        
        prevBtn.addEventListener('click', showPreviousSentence);
        nextBtn.addEventListener('click', showNextSentence);
        
        // 15. 键盘支持
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowLeft') {
                showPreviousSentence();
            } else if (event.key === 'ArrowRight') {
                showNextSentence();
            }
        });
        
        // 16. 初始化应用
        async function initApp() {
            await initFileSelect();
            loadingElement.style.display = 'none';
        }
        
        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
        
        // 17. 添加简单的进度显示
        function updateProgress() {
            if (currentSentences.length > 0) {
                const progress = Math.round(((currentIndex + 1) / currentSentences.length) * 100);
                currentFileElement.textContent = `${currentFileName.replace('.txt', '')} (${progress}%)`;
            }
        }
        
        // 在渲染句子时更新进度
        const originalRender = renderCurrentSentence;
        renderCurrentSentence = function() {
            originalRender();
            updateProgress();
        };
    </script>
</body>
</html>
