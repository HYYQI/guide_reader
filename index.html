<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>å¯¼æ¸¸è¯é˜…è¯»å™¨</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f8fc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1a3243;
        }
        .navbar {
            background: white;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-bottom: 1px solid #d0deee;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .logo {
            font-weight: 600;
            color: #1e4b6e;
            margin-right: 0.25rem;
            font-size: 1rem;
        }
        .file-select {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.4rem;
            flex: 1;
        }
        .file-select select {
            flex: 1;
            min-width: 180px;
            padding: 0.4rem 1.8rem 0.4rem 0.8rem;
            border-radius: 24px;
            border: 1px solid #b4c9db;
            background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>') no-repeat right 8px center;
            background-size: 14px;
            appearance: none;
            font-size: 0.95rem;
        }
        .refresh-btn {
            background: #ecf2f8;
            border: 1px solid #adc2d4;
            border-radius: 30px;
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .refresh-btn:active { background: #d7e2ed; }
        .reader {
            flex: 1;
            padding: 1rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .paper {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 16px rgba(0,20,30,0.08);
            padding: 1.5rem 1.2rem;
            min-height: 60vh;
        }
        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding-bottom: 0.8rem;
            margin-bottom: 1.2rem;
            border-bottom: 1px dashed #c8d8e8;
        }
        .file-name {
            font-size: 1.3rem;
            font-weight: 500;
            color: #144a6f;
            word-break: break-word;
        }
        .count {
            background: #e2ecf5;
            padding: 0.2rem 0.9rem;
            border-radius: 30px;
            font-size: 0.8rem;
            color: #1e4b70;
        }
        .sentence-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .sentence-item {
            padding: 0.8rem 1rem 0.8rem 1.2rem;
            background: #f9fcff;
            border-left: 4px solid #6f9bc0;
            border-radius: 8px 16px 16px 8px;
            font-size: 1.1rem;
            line-height: 1.6;
            word-break: break-word;
        }
        .placeholder, .error, .loading {
            text-align: center;
            padding: 3rem 1rem;
            border-radius: 40px;
        }
        .placeholder { color: #627d96; background: #f0f7ff; border: 2px dashed #c1d6e8; }
        .error { color: #b13e3e; background: #ffecec; }
        .loading { color: #2f6585; background: #e8f0fa; }
    </style>
</head>

<body>
    <div class="navbar"><span class="logo">ğŸ“– å¯¼æ¸¸è¯</span>
        <div class="file-select"><select id="fileSelector" aria-label="é€‰æ‹©å¯¼æ¸¸è¯">
                <option value="">â€” åŠ è½½é…ç½® â€”</option>
            </select><button class="refresh-btn" id="refreshBtn">â†» åˆ·æ–°</button></div>
    </div>
    <div class="reader">
        <div class="paper" id="readerPaper">
            <div class="placeholder">ğŸ“ é€‰æ‹©ä¸Šæ–¹æ–‡ä»¶å¼€å§‹é˜…è¯»</div>
        </div>
    </div>
    <script>
        (function() {
            const fileSelector = document.getElementById('fileSelector');
            const refreshBtn = document.getElementById('refreshBtn');
            const readerPaper = document.getElementById('readerPaper');
        
            // æ•°æ®ç»“æ„: å­˜å‚¨ä»jsonè§£æçš„æ¡ç›® [{ name: "æ•…å®«", file: "gugong.txt" }, ...]
            let guideList = [];
            let currentFile = ''; // å½“å‰é€‰ä¸­çš„æ–‡ä»¶åï¼ˆå®é™…txtæ–‡ä»¶åï¼‰
        
            function showPlaceholder(msg) {
                readerPaper.innerHTML = `<div class="placeholder">${msg || 'ğŸ“ é€‰æ‹©æ–‡ä»¶'}</div>`;
            }
        
            function showError(msg) {
                readerPaper.innerHTML = `<div class="error">âŒ ${msg}</div>`;
            }
        
            function showLoading() {
                readerPaper.innerHTML = `<div class="loading">â³ åŠ è½½ä¸­...</div>`;
            }
        
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
        
            // æŒ‰å¥å­æ‹†åˆ†ï¼ˆå¤„ç†æ¢è¡Œ/ç©ºæ ¼ï¼Œé¿å…æ‹†åˆ†å°æ•°ï¼‰
            function splitSentences(text) {
                if (!text) return [];
        
                // 1. ç»Ÿä¸€æ¢è¡Œç¬¦ä¸º \n
                let clean = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
                // 2. å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºç‰¹æ®Šæ ‡è®°ï¼Œæš‚æ—¶ä¿æŠ¤
                //    ç”¨å ä½ç¬¦æ›¿æ¢æ¢è¡Œï¼Œåé¢å†è½¬æˆå¥å­åˆ†éš”
                clean = clean.replace(/\n/g, ' ###NEWLINE### ');
        
                // 3. åˆ†å¥æ­£åˆ™ï¼š
                //    - é¿å…æ‹†åˆ†å°æ•° (å¦‚ 3.14 ä¸­çš„ç‚¹)
                //    - åŒ¹é…ä¸­æ–‡/è‹±æ–‡å¥å·ã€é—®å·ã€æ„Ÿå¹å·ä½œä¸ºå¥å­ç»“æŸ
                //    - åé¢å¯ä»¥è·Ÿç©ºæ ¼æˆ–æ¢è¡Œï¼ˆå·²è½¬æˆå ä½ç¬¦ï¼‰
                //    - ä½¿ç”¨æ­£å‘é¢„æŸ¥ä¿ç•™æ ‡ç‚¹ç¬¦å·
                const sentences = [];
                // åˆ†å¥æ ‡è®°ï¼š(ã€‚ï¼ï¼Ÿ.!?ï¼‰åé¢è·Ÿç©ºæ ¼æˆ–å ä½ç¬¦ï¼Œä½†ä¸åŒ…æ‹¬å°æ•°ç‚¹å’Œæ•°å­—ç»„åˆ
                // å…ˆä¸´æ—¶æ ‡è®°æ‰€æœ‰å¯èƒ½çš„å¥å­è¾¹ç•Œ
                let marked = clean.replace(/([ã€‚ï¼ï¼Ÿ.!?])(?=\s|###NEWLINE###|$)/g, '$1###SPLIT###');
        
                // ä¿®å¤å°æ•°è¯¯åˆ¤ï¼šæŠŠæ•°å­—.æ•°å­—ä¹‹é—´çš„æ ‡è®°å»æ‰
                marked = marked.replace(/(\d)\.###SPLIT###(\d)/g, '$1.$2');
        
                // æŒ‰###SPLIT###åˆ†å‰²
                const rawSegments = marked.split('###SPLIT###').filter(s => s.trim().length > 0);
        
                // å¤„ç†æ¯ä¸ªç‰‡æ®µï¼ŒæŠŠ###NEWLINE###è¿˜åŸæˆæ¢è¡Œï¼Œä½†æ¢è¡Œä¹Ÿä½œä¸ºå¥å­åˆ†éš”
                for (let seg of rawSegments) {
                    // å¦‚æœç‰‡æ®µä¸­åŒ…å«æ¢è¡Œå ä½ç¬¦ï¼Œè¿›ä¸€æ­¥æŒ‰æ¢è¡Œæ‹†åˆ†
                    if (seg.includes('###NEWLINE###')) {
                        const subSegs = seg.split('###NEWLINE###').filter(s => s.trim().length > 0);
                        sentences.push(...subSegs.map(s => s.trim()));
                    } else {
                        sentences.push(seg.trim());
                    }
                }
        
                // 4. è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²å’Œåªæœ‰ç©ºæ ¼çš„è¡Œ
                return sentences.filter(s => s.length > 0);
            }
        
            function renderContent(content, displayName, fileName) {
                if (!content || content.trim() === '') {
                    readerPaper.innerHTML = `
                                <div class="file-header">
                                    <span class="file-name">${escapeHtml(displayName)}</span>
                                    <span class="count">ç©ºæ–‡ä»¶</span>
                                </div>
                                <div class="placeholder">ğŸ“­ æ²¡æœ‰å†…å®¹</div>
                            `;
                    return;
                }
                const sentences = splitSentences(content);
                const header = `
                            <div class="file-header">
                                <span class="file-name">${escapeHtml(displayName)}</span>
                                <span class="count">${sentences.length} å¥</span>
                            </div>
                        `;
                let listHtml = '<div class="sentence-list">';
                sentences.forEach(s => {
                    listHtml += `<div class="sentence-item">${escapeHtml(s)}</div>`;
                });
                listHtml += '</div>';
                readerPaper.innerHTML = header + listHtml;
            }
        
            // åŠ è½½å…·ä½“æ–‡ä»¶å†…å®¹ (fileName æ˜¯å®é™…txtæ–‡ä»¶åï¼Œå¦‚ "gugong.txt")
            function loadFileContent(fileName, displayName) {
                if (!fileName) return;
                showLoading();
                // æ„å»ºè·¯å¾„ï¼štext/æ–‡ä»¶å
                const filePath = `./text/${encodeURIComponent(fileName)}`;
                fetch(filePath)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return res.text();
                    })
                    .then(text => renderContent(text, displayName, fileName))
                    .catch(err => {
                        console.error(err);
                        showError(`è¯»å–å¤±è´¥: ${displayName} (${err.message})`);
                    });
            }
        
            // åŠ è½½JSONé…ç½®æ–‡ä»¶
            function loadGuideList() {
                fileSelector.disabled = true;
                fileSelector.innerHTML = '<option value="">â€” åŠ è½½é…ç½® â€”</option>';
        
                // å°è¯•è¯»å–åŒçº§çš„ text/list.json æˆ–æ ¹ç›®å½•list.jsonï¼Œä½†æŒ‰éœ€æ±‚ä»textç›®å½•è·å–ï¼Œè¿™é‡Œæ”¾åœ¨ ./text/list.json
                fetch('./text/list.json?t=' + Date.now()) // åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`æ— æ³•åŠ è½½list.json (${response.status})`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šæ•°ç»„ [{name, file}] æˆ– {list: [...]}
                        let items = [];
                        if (Array.isArray(data)) {
                            items = data;
                        } else if (data.list && Array.isArray(data.list)) {
                            items = data.list;
                        } else if (data.guides && Array.isArray(data.guides)) {
                            items = data.guides;
                        } else {
                            throw new Error('JSONæ ¼å¼ä¸å¯¹ï¼Œåº”ä¸ºæ•°ç»„æˆ–åŒ…å«listå­—æ®µçš„æ•°ç»„');
                        }
        
                        // è¿‡æ»¤ï¼šå¿…é¡»æœ‰nameå’Œfileå­—æ®µï¼Œfileä»¥.txtç»“å°¾
                        guideList = items.filter(item => item.name && item.file && item.file.toLowerCase().endsWith('.txt'));
        
                        if (guideList.length === 0) {
                            fileSelector.innerHTML = '<option value="">â€” æ— æœ‰æ•ˆå¯¼æ¸¸è¯ â€”</option>';
                            fileSelector.disabled = false;
                            showPlaceholder('list.jsonä¸­æ— æœ‰æ•ˆæ¡ç›®');
                            return;
                        }
        
                        // æ„å»ºä¸‹æ‹‰é€‰é¡¹
                        let options = '<option value="">â€” é€‰æ‹©å¯¼æ¸¸è¯ â€”</option>';
                        guideList.forEach((item, index) => {
                            // ç”¨æ–‡ä»¶åä½œä¸ºvalueï¼Œæ˜¾ç¤ºåç§°ä½œä¸ºæ–‡æœ¬
                            const selected = (item.file === currentFile) ? 'selected' : '';
                            options += `<option value="${escapeHtml(item.file)}" data-display="${escapeHtml(item.name)}" ${selected}>${escapeHtml(item.name)}</option>`;
                        });
                        fileSelector.innerHTML = options;
                        fileSelector.disabled = false;
        
                        // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„æ–‡ä»¶ä¸”åœ¨åˆ—è¡¨ä¸­ï¼Œè‡ªåŠ¨åŠ è½½
                        if (currentFile) {
                            const found = guideList.find(item => item.file === currentFile);
                            if (found) {
                                loadFileContent(found.file, found.name);
                            } else {
                                currentFile = '';
                                showPlaceholder('è¯·é€‰æ‹©å¯¼æ¸¸è¯');
                            }
                        }
                    })
                    .catch(err => {
                        console.error('åŠ è½½list.jsonå¤±è´¥:', err);
                        fileSelector.innerHTML = '<option value="">â€” åŠ è½½å¤±è´¥ â€”</option>';
                        fileSelector.disabled = false;
                        showError(`æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨: ${err.message}`);
                    });
            }
        
            // é€‰æ‹©äº‹ä»¶
            fileSelector.addEventListener('change', function(e) {
                const selectedFile = e.target.value; // æ–‡ä»¶å
                if (!selectedFile) {
                    currentFile = '';
                    showPlaceholder('è¯·é€‰æ‹©å¯¼æ¸¸è¯');
                    return;
                }
        
                // æ‰¾åˆ°å¯¹åº”çš„æ¡ç›®
                const selectedItem = guideList.find(item => item.file === selectedFile);
                if (selectedItem) {
                    currentFile = selectedItem.file;
                    loadFileContent(selectedItem.file, selectedItem.name);
                } else {
                    // å®¹é”™ï¼šåˆ·æ–°åˆ—è¡¨
                    loadGuideList();
                }
            });
        
            refreshBtn.addEventListener('click', function() {
                loadGuideList();
            });
        
            // åˆå§‹åŒ–
            loadGuideList();
        })();
    </script>
</body>

</html>